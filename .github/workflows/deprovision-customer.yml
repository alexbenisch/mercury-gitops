name: Deprovision Customer

on:
  workflow_dispatch:
    inputs:
      customer_name:
        description: 'Customer name to remove (e.g., customer2, customer3)'
        required: true
        type: string
      delete_dns:
        description: 'Delete Cloudflare DNS record?'
        required: true
        type: boolean
        default: true

jobs:
  deprovision:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Validate customer name
        run: |
          if [[ ! "${{ inputs.customer_name }}" =~ ^customer[0-9]+$ ]]; then
            echo "ERROR: Customer name must be in format 'customerN' (e.g., customer2, customer3)"
            exit 1
          fi

      - name: Check if customer exists
        run: |
          if [ ! -d "apps/base/${{ inputs.customer_name }}" ]; then
            echo "ERROR: Customer ${{ inputs.customer_name }} does not exist"
            exit 1
          fi

      - name: Delete Cloudflare DNS record
        if: inputs.delete_dns == true
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_DNS_KUBETEST_UK }}
          ZONE_NAME: kubetest.uk
          SUBDOMAIN: ${{ inputs.customer_name }}.mercury.kubetest.uk
        run: |
          python3 - <<'EOF'
          import os
          import sys
          import requests

          api_token = os.getenv('CF_API_TOKEN')
          zone_name = os.getenv('ZONE_NAME')
          subdomain = os.getenv('SUBDOMAIN')

          base_url = 'https://api.cloudflare.com/client/v4'
          headers = {
              'Authorization': f'Bearer {api_token}',
              'Content-Type': 'application/json'
          }

          # Get zone ID
          print(f"Looking up zone ID for: {zone_name}")
          response = requests.get(
              f'{base_url}/zones',
              headers=headers,
              params={'name': zone_name}
          )
          response.raise_for_status()
          zones = response.json()['result']
          if not zones:
              print(f"ERROR: Zone {zone_name} not found")
              sys.exit(1)
          zone_id = zones[0]['id']
          print(f"Found zone ID: {zone_id}")

          # Check for existing record
          print(f"Looking for DNS record: {subdomain}")
          response = requests.get(
              f'{base_url}/zones/{zone_id}/dns_records',
              headers=headers,
              params={'name': subdomain, 'type': 'A'}
          )
          response.raise_for_status()

          existing = response.json()['result']

          if existing:
              record_id = existing[0]['id']
              print(f"Found DNS record: {subdomain}")
              print(f"Deleting DNS record...")
              response = requests.delete(
                  f'{base_url}/zones/{zone_id}/dns_records/{record_id}',
                  headers=headers
              )
              response.raise_for_status()
              print("✓ DNS record deleted")
          else:
              print(f"⚠ DNS record not found: {subdomain} (may have been deleted already)")
          EOF

      - name: Remove customer manifests
        run: |
          chmod +x .github/scripts/deprovision-customer.py
          python3 .github/scripts/deprovision-customer.py "${{ inputs.customer_name }}"

      - name: Remove Terraform configuration
        run: |
          chmod +x .github/scripts/remove-terraform.py
          python3 .github/scripts/remove-terraform.py "${{ inputs.customer_name }}"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          commit-message: |
            feat: deprovision ${{ inputs.customer_name }}

            - Remove Cloudflare DNS record: ${{ inputs.customer_name }}.mercury.kubetest.uk
            - Remove Kubernetes manifests for ${{ inputs.customer_name }}
            - Remove Azure Key Vault secrets from Terraform
          branch: deprovision/${{ inputs.customer_name }}
          delete-branch: true
          title: 'feat: Deprovision ${{ inputs.customer_name }}'
          body: |
            ## Customer Deprovisioning

            This PR removes customer `${{ inputs.customer_name }}` and all associated resources.

            - **Customer Name**: `${{ inputs.customer_name }}`
            - **Domain**: `${{ inputs.customer_name }}.mercury.kubetest.uk`
            - **DNS Deletion**: ${{ inputs.delete_dns && '✅ Deleted' || '⏭️ Skipped' }}

            ## Changes

            ### DNS
            - ${{ inputs.delete_dns && '✅ Cloudflare DNS A record deleted' || '⏭️ DNS record deletion skipped' }}

            ### Kubernetes Manifests
            - ✅ Removed namespace: `${{ inputs.customer_name }}`
            - ✅ Removed PostgreSQL database cluster
            - ✅ Removed n8n deployment
            - ✅ Removed ingress and TLS certificate
            - ✅ Removed Azure Key Vault integration

            ### Terraform
            - ✅ Removed Key Vault secrets configuration

            ## Next Steps

            1. Review the changes in this PR
            2. Merge this PR to trigger Flux cleanup
            3. After merge, apply Terraform changes:
               ```bash
               terraform plan
               terraform apply
               ```
            4. Wait for Flux to sync (check with `flux get kustomizations`)
            5. Verify deletion: `kubectl get namespace ${{ inputs.customer_name }}`
            6. Verify Key Vault secrets removed:
               ```bash
               az keyvault secret list --vault-name kv-mercury-staging | grep ${{ inputs.customer_name }}
               ```

            ## What Gets Deleted

            **Immediately (after PR merge):**
            - Kubernetes namespace and all pods/services
            - Persistent Volume Claims (PVCs) and data
            - Ingress routes
            - TLS certificates

            **After Terraform Apply:**
            - Azure Key Vault secrets

            ## Rollback

            To restore this customer, re-run the provisioning workflow with the same customer name.

            ⚠️ **Warning:** All customer data will be permanently deleted.
          labels: |
            deprovisioning
            automated
